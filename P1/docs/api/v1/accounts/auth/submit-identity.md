# 📌 Endpoint: `POST /api/v1/accounts/auth/submit-identity/`

### 🎯 کاربرد:

این API برای ثبت شناسه کاربر (ایمیل یا شماره موبایل ایرانی) استفاده می‌شود. در صورت اعتبارسنجی موفق، یک کد تأیید (OTP) یا لینک تأیید برای ادامه فرایند ثبت‌نام یا بازیابی حساب ارسال خواهد شد.

> این مرحله، **اولین گام** در فرآیند احراز هویت (ثبت‌نام، ورود یا بازیابی رمز عبور) است.

---

## 📋 شرایط استفاده

* ✅ فقط کاربران **(unauthenticated)** مجاز به استفاده هستند.
* ✅ ارسال **توکن کپچا Turnstile** الزامی است.
* ⏱ پس از ارسال موفق، تا **۳ دقیقه** برای همان شناسه امکان ارسال مجدد وجود ندارد.
* 🚦 این endpoint تحت **محدودیت نرخ (Rate Limiting)** است:

  * در صورت عبور از حد مجاز، پاسخ `429` همراه با زمان باقی‌مانده ارسال می‌شود.

---

## 🔐 سطح دسترسی

| شرط                          | وضعیت                        |
| ---------------------------- | ---------------------------- |
| نیاز به لاگین؟               | ❌ خیر (مخصوص مهمان‌ها)       |
| کپچا اجباری؟                 | ✅ بله (Cloudflare Turnstile) |
| محدودیت نرخ (Throttle) فعال؟ | ✅ بله                        |

---

## 📨 درخواست

### ➤ Method: `POST`

### ➤ URL: `/api/v1/accounts/auth/submit-identity/`

---

### Headers

| کلید         | مقدار              |
| ------------ | ------------------ |
| Content-Type | `application/json` |

---

### Body (JSON)

```json
{
  "identity": "example@example.com",
  "cf-turnstile-response": "CAPTCHA_TOKEN"
}
```

| فیلد                    | نوع    | الزامی؟ | توضیح                                        |
| ----------------------- | ------ | ------- | -------------------------------------------- |
| `identity`              | string | ✅       | ایمیل یا شماره موبایل ایرانی (`09xxxxxxxxx`) |
| `cf-turnstile-response` | string | ✅       | توکن معتبر کپچای Turnstile                   |

---

## 🧪 نمونه‌های معتبر

#### ✅ ارسال موبایل:

```json
{ 
  "identity": "09123456789", 
  "cf-turnstile-response": "TOKEN" 
}
```

#### ✅ ارسال ایمیل:

```json
{ 
  "identity": "user@example.com", 
  "cf-turnstile-response": "TOKEN" 
}
```

---

## ✅ پاسخ موفق

### ✔️ Status Code: `200 OK`

```json
{
  "detail": "کد تایید به شماره موبایل شما ارسال شد.",
  "next_url": "/api/v1/accounts/auth/verify-otp/",
  "purpose": "register"
}
```

| فیلد       | توضیح                                                  |
| ---------- | ------------------------------------------------------ |
| `detail`   | پیام موفقیت‌آمیز ارسال OTP یا لینک                     |
| `next_url` | مسیر مرحله بعد که کلاینت باید کاربر را به آن هدایت کند |
| `purpose`  | هدف عملیات (`register`، `login`، `reset_password`)     |

---

## ❌ پاسخ‌های خطا

| کد وضعیت | توضیح                                | نمونه پاسخ                                                                                                      |
| -------- | ------------------------------------ | --------------------------------------------------------------------------------------------------------------- |
| `400`    | ورودی نامعتبر یا کپچا ناموفق         | 👇 نمونه‌ها در ادامه                                                                                            |
| `403`    | کاربر وارد شده و اجازه استفاده ندارد | `{ "detail": "شما قبلاً وارد شده‌اید." }`                                                                       |
| `429`    | عبور از حد مجاز تعداد درخواست        | `{ "detail": "شما بیش از حد مجاز درخواست ارسال کرده‌اید.", "available_in_seconds": 42, "limit": 5, "used": 5 }` |
| `500`    | خطای داخلی سرور یا مشکل غیرمنتظره    | `{ "detail": "خطای ناشناخته‌ای رخ داده است. لطفاً دوباره تلاش کنید." }`                                         |

---

### 📉 نمونه پاسخ 400

#### ❗ ورودی نامعتبر:

```json
{
  "identity": ["ورودی نامعتبر است. لطفاً یک ایمیل یا شماره تلفن معتبر وارد کنید."]
}
```

#### ❗ کپچا ناموفق:

```json
{
  "detail": "اعتبارسنجی کپچا ناموفق بود."
}
```

---

### 🚦 نمونه پاسخ 429 (Throttle فعال)

```json
{
  "detail": "شما بیش از حد مجاز درخواست ارسال کرده‌اید.",
  "available_in_seconds": 42
}
```

| فیلد                   | توضیح                                     |
| ---------------------- | ----------------------------------------- |
| `detail`               | پیام خطا                                  |
| `available_in_seconds` | زمان باقی‌مانده (به ثانیه) برای تلاش مجدد |

---