# 📌 Endpoint: `POST /api/v1/accounts/auth/resend-otp-or-link/`

### 🎯 کاربرد:

این API برای ارسال مجدد کد تأیید (OTP) یا لینک ثبت‌نام به کاربر استفاده می‌شود. سیستم به طور خودکار تشخیص می‌دهد که کاربر جدید است یا قبلاً ثبت‌نام کرده و پیام مناسب را ارسال می‌کند:

*   **کاربران موجود:** کد ورود (OTP) به ایمیل یا موبایل ارسال می‌شود.
*   **کاربران جدید:**
    *   اگر شناسه **ایمیل** باشد، لینک ثبت‌نام ارسال می‌شود.
    *   اگر شناسه **موبایل** باشد، کد ثبت‌نام (OTP) ارسال می‌شود.

> این endpoint برای بازیابی دسترسی یا ادامه فرآیند ثبت‌نام کاربرد دارد.

---

## 📋 شرایط استفاده

* ✅ فقط کاربران **(unauthenticated)** مجاز به استفاده هستند.
* ✅ ارسال **توکن کپچا Turnstile** الزامی است.
* ⏱ پس از هر بار درخواست برای یک شناسه، تا **۲ دقیقه** امکان ارسال مجدد وجود ندارد.
* 🚦 این endpoint تحت **محدودیت نرخ (Rate Limiting)** است.

---

## 🔐 سطح دسترسی

| شرط                          | وضعیت                        |
| ---------------------------- | ---------------------------- |
| نیاز به لاگین؟               | ❌ خیر (مخصوص مهمان‌ها)       |
| کپچا اجباری؟                 | ✅ بله (Cloudflare Turnstile) |
| محدودیت نرخ (Throttle) فعال؟ | ✅ بله                        |

---

## 📨 درخواست

### ➤ Method: `POST`

### ➤ URL: `/api/v1/accounts/auth/resend-otp-or-link/`

---

### Headers

| کلید         | مقدار              |
| ------------ | ------------------ |
| Content-Type | `application/json` |

---

### Body (JSON)

| فیلد                    | نوع    | الزامی؟ | توضیح                                     |
| ----------------------- | ------ | ------- | ----------------------------------------- |
| `identity`              | string | ✅       | ایمیل یا شماره موبایل کاربر               |
| `cf_turnstile_response` | string | ✅       | توکن معتبر کپچای Turnstile                |

---

## 🧪 نمونه درخواست

```json
{
  "identity": "user@example.com",
  "cf_turnstile_response": "CAPTCHA_TOKEN"
}
```

---

## ✅ پاسخ موفق

### ✔️ Status Code: `200 OK`

بسته به وضعیت کاربر (جدید/موجود) و نوع شناسه (ایمیل/موبایل)، یکی از پاسخ‌های زیر بازگردانده می‌شود:

#### ارسال مجدد کد ورود (کاربر موجود)

```json
{
  "detail": "کد ورود به ایمیل/شماره شما ارسال شد",
  "purpose": "login",
  "next_url": "/api/v1/accounts/auth/verify-otp/"
}
```

#### ارسال مجدد لینک ثبت‌نام (کاربر جدید با ایمیل)

```json
{
  "detail": "لینک ثبت‌نام به ایمیل شما ارسال شد",
  "purpose": "register",
  "next_url": "/api/v1/accounts/auth/verify-link/"
}
```

#### ارسال مجدد کد ثبت‌نام (کاربر جدید با موبایل)

```json
{
  "detail": "کد ثبت‌نام برای شماره شما ارسال شد",
  "purpose": "register",
  "next_url": "/api/v1/accounts/auth/verify-otp/"
}
```

| فیلد       | توضیح                                                        |
| ---------- | ------------------------------------------------------------ |
| `detail`   | پیام موفقیت‌آمیز                                             |
| `purpose`  | هدف از ارسال (`login` یا `register`)                          |
| `next_url` | آدرس API که کاربر باید در مرحله بعد به آن مراجعه کند         |

---

## ❌ پاسخ‌های خطا

| کد وضعیت | توضیح                               | نمونه پاسخ                                                                                                      |
| -------- | ----------------------------------- | --------------------------------------------------------------------------------------------------------------- |
| `400`    | ورودی نامعتبر                        | 👇 نمونه‌ها در ادامه                                                                                            |
| `403`    | کاربر وارد شده و اجازه استفاده ندارد    | `{ "detail": "شما قبلاً وارد شده‌اید." }`                                                                       |
| `429`    | عبور از حد مجاز تعداد درخواست       | `{ "detail": "تعداد درخواست‌ها بیش از حد مجاز است. لطفاً پس از ۲ دقیقه دوباره تلاش کنید.", "available_in_seconds": 120 }` |
| `500`    | خطای داخلی سرور                      | `{ "detail": "خطای ناشناخته‌ای رخ داده است. لطفاً دوباره تلاش کنید." }`                                         |

---

### 📉 نمونه پاسخ 400

#### ❗ خطاهای اعتبارسنجی فیلدها:

```json
{
  "identity": ["وارد کردن ایمیل یا شماره تلفن الزامی است."],
  "cf_turnstile_response": ["اعتبارسنجی کپچا ناموفق بود."]
}
```

#### ❗ ایمیل نامعتبر:

```json
{
  "identity": ["ایمیل نامعتبر است. لطفاً یک ایمیل معتبر مانند example@example.com وارد کنید."]
}
```

#### ❗ شماره موبایل نامعتبر:

```json
{
  "identity": ["ورودی نامعتبر است. لطفاً یک ایمیل یا شماره تلفن معتبر وارد کنید."]
}
