# سیستم احراز هویت (Authentication)

این سند به تشریح کامل فرآیندهای احراز هویت و مدیریت کاربران در پروژه Learnfolio می‌پردازد. سیستم احراز هویت این پروژه مبتنی بر توکن **JWT (JSON Web Token)** است و از کتابخانه `djangorestframework-simplejwt` برای پیاده‌سازی آن استفاده شده است.

---

## 🌊 جریان کلی احراز هویت

پروژه دو مسیر اصلی برای ورود و ثبت‌نام کاربران فراهم می‌کند:

1.  **Passwordless (بدون رمز عبور)**: کاربر با استفاده از ایمیل یا شماره موبایل خود هویتش را تایید می‌کند و یک کد یکبار مصرف (OTP) یا لینک تایید دریافت می‌کند.
2.  **Password-based (با رمز عبور)**: روش سنتی که در آن کاربر با استفاده از شماره موبایل/ایمیل و رمز عبور خود وارد سیستم می‌شود.

پس از احراز هویت موفق، دو توکن به کاربر بازگردانده می‌شود:
- **`access_token`**: توکنی با عمر کوتاه (در اینجا ۱۵ دقیقه) که برای دسترسی به APIهای نیازمند احراز هویت استفاده می‌شود.
- **`refresh_token`**: توکنی با عمر طولانی (در اینجا ۷ روز) که برای دریافت `access_token` جدید بدون نیاز به ورود مجدد به کار می‌رود.

---

## 🔗 اندپوینت‌های اصلی API

تمامی اندپوینت‌های زیر تحت پیشوند `/api/v1/accounts/auth/` در دسترس هستند.

| اندپوینت                  | متد   | توضیح                                                                                                                               |
|----------------------------|--------|-------------------------------------------------------------------------------------------------------------------------------------|
| `submit-identity/`         | `POST` | **مرحله اول**: کاربر ایمیل یا شماره موبایل خود را ارسال می‌کند. سیستم بررسی می‌کند که آیا کاربر وجود دارد یا خیر و یک OTP/لینک برای او ارسال می‌کند. |
| `verify-otp/`              | `POST` | **مرحله دوم (OTP)**: کاربر کد OTP دریافت شده را برای تایید هویت و دریافت توکن‌های JWT ارسال می‌کند.                                     |
| `verify-link/`             | `POST`  | **مرحله دوم (Link)**: کاربر روی لینک ارسال شده به ایمیل خود کلیک می‌کند تا هویت خود را تایید و توکن‌ها را دریافت نماید.               |
| `login-password/`          | `POST` | **ورود با رمز عبور**: کاربر با ارسال شماره موبایل/ایمیل و رمز عبور، توکن‌های JWT را دریافت می‌کند.                                   |
| `resend-otp-or-link/`      | `POST` | **ارسال مجدد**: در صورتی که کاربر OTP یا لینک را دریافت نکرد، می‌تواند درخواست ارسال مجدد دهد. (دارای محدودیت نرخ)                   |
| `token/refresh/`           | `POST` | **تمدید توکن**: کاربر با ارسال `refresh_token` معتبر، یک `access_token` جدید دریافت می‌کند.                                       |
| `logout/`                  | `POST` | **خروج**: کاربر با ارسال `refresh_token` معتبر، خروج از حساب خود را انجام می‌دهد.                                       |

---

## 🔑 اندپوینت‌های مدیریت رمز عبور

تمامی اندپوینت‌های زیر تحت پیشوند `/api/v1/accounts/password/` در دسترس هستند.

| اندپوینت                  | متد   | توضیح                                                                                                                               |
|----------------------------|--------|-------------------------------------------------------------------------------------------------------------------------------------|
| `request-password-reset/`  | `POST` | **درخواست بازنشانی**: کاربر ایمیل یا شماره موبایل خود را برای دریافت کد/لینک بازنشانی رمز عبور ارسال می‌کند.                               |
| `verify-otp/`              | `POST` | **تایید کد بازنشانی**: کاربر کد OTP دریافت شده را برای تایید و دریافت توکن بازنشانی ارسال می‌کند.                                        |
| `verify-link/`             | `POST` | **تایید لینک بازنشانی**: کاربر روی لینک ارسال شده کلیک کرده و توکن بازنشانی را دریافت می‌کند.                                            |
| `reset-password/`          | `POST` | **تنظیم رمز جدید**: کاربر با استفاده از توکن بازنشانی، رمز عبور جدیدی برای حساب خود تنظیم می‌کند.                                           |
| `change-password/`         | `POST` | **تغییر رمز عبور**: کاربرانی که وارد شده‌اند، می‌توانند با ارائه رمز فعلی، رمز عبور خود را تغییر دهند.                                     |
| `first-time-password/`     | `POST` | **تنظیم رمز برای اولین بار**: کاربرانی که با شبکه‌های اجتماعی ثبت‌نام کرده و رمز عبور ندارند، می‌توانند برای حساب خود رمز تعیین کنند.     |

---

## 🛡️ امنیت و توکن‌ها

- **عمر کوتاه Access Token**: عمر کوتاه `access_token` ریسک امنیتی در صورت سرقت توکن را کاهش می‌دهد.
- **چرخش Refresh Token (Token Rotation)**: با هر بار استفاده از `refresh_token`، یک توکن جدید صادر می‌شود و توکن قبلی باطل می‌گردد. این کار امنیت را افزایش می‌دهد.
- **لیست سیاه (Blacklist)**: توکن‌های `refresh` پس از استفاده در لیست سیاه قرار می‌گیرند تا از استفاده مجدد آن‌ها جلوگیری شود.
- **Rate Limiting**: اندپوینت‌های حساس مانند `resend-otp-or-link` دارای محدودیت نرخ درخواست هستند تا از حملات Brute-force جلوگیری شود.
- **Captcha (Turnstile)**: فرم‌های ورود و ثبت‌نام می‌توانند با سرویس کپچای Cloudflare Turnstile محافظت شوند تا از ورود ربات‌ها جلوگیری شود.
